#!/usr/bin/env bash
set -euo pipefail  # http://redsymbol.net/articles/unofficial-bash-strict-mode/

local_install_mode=0
for i in "$@" ; do
    if [[ $i == "--local" ]] ; then
        local_install_mode=1
        break
    fi
done

if [[ local_install_mode -eq 0 ]]; then
	echo 'Installing from remote source...'
else
	echo 'Installing from local source...'
fi

XCODE_BIN_DIR="`xcode-select -p`/usr/bin"
XCODE_GIT="$XCODE_BIN_DIR/xcode-git"
GIT="$XCODE_BIN_DIR/git"
GIT_URL="https://raw.githubusercontent.com/chrisdanford/BetterXcodeGitBlame/master/git"
GIT_TEMP="/tmp/git-wrapper"
LOCAL_INSTALL_GIT_SOURCE="./git"

if [ -f $XCODE_GIT ]; then
   echo "Looks like we're already installed. File "$XCODE_GIT" already exists."
   echo ""
   echo "If you'd like to uninstall:"
   echo "sudo mv -f $XCODE_GIT $GIT"
   exit 0
fi
if [[ local_install_mode -eq 0 ]]; then
	curl --output "$GIT_TEMP" "$GIT_URL"
fi
echo ''
echo "Location of the Xcode-packaged git: $XCODE_BIN_DIR"
echo ''
echo 'The contents of Xcode will be modified.'
echo 'You may be prompted for your password. "sudo" is necessary to continue.'
sudo -- mv "$GIT" "$XCODE_GIT"
if [[ local_install_mode -eq 0 ]]; then
	sudo -- mv "$GIT_TEMP" "$GIT"
else
	sudo -- cp "$LOCAL_INSTALL_GIT_SOURCE" "$GIT"	
fi
sudo -- chmod +x "$GIT"
echo 'All done!'
